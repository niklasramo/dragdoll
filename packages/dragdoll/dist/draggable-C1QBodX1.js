import{ticker as e,tickerPhases as t}from"./ticker-CAFcKU20.js";import{getStyle as n}from"./get-style-ZZHAkgcg.js";import{IS_BROWSER as r}from"./constants-gNukEJzy.js";import{SensorEventType as i}from"./sensor-C-EBcfly.js";import{Emitter as a}from"eventti";import{getOffsetContainer as o}from"mezr/getOffsetContainer";function s(e,t){return e.isIdentity&&t.isIdentity?!0:e.is2D&&t.is2D?e.a===t.a&&e.b===t.b&&e.c===t.c&&e.d===t.d&&e.e===t.e&&e.f===t.f:e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m21===t.m21&&e.m22===t.m22&&e.m23===t.m23&&e.m24===t.m24&&e.m31===t.m31&&e.m32===t.m32&&e.m33===t.m33&&e.m34===t.m34&&e.m41===t.m41&&e.m42===t.m42&&e.m43===t.m43&&e.m44===t.m44}function c(e){return e.m11!==1||e.m12!==0||e.m13!==0||e.m14!==0||e.m21!==0||e.m22!==1||e.m23!==0||e.m24!==0||e.m31!==0||e.m32!==0||e.m33!==1||e.m34!==0||e.m43!==0||e.m44!==1}function l(e,t,n=null){if(`moveBefore`in e&&e.isConnected===t.isConnected)try{e.moveBefore(t,n);return}catch{}let r=document.activeElement,i=t.contains(r);e.insertBefore(t,n),i&&document.activeElement!==r&&r instanceof HTMLElement&&r.focus({preventScroll:!0})}function u(e){return e.setMatrixValue(`scale(1, 1)`)}function d(e,t=0){let n=10**t;return Math.round((e+2**-52)*n)/n}var f=class{constructor(){this._cache=new Map,this._validation=new Map}set(e,t){this._cache.set(e,t),this._validation.set(e,void 0)}get(e){return this._cache.get(e)}has(e){return this._cache.has(e)}delete(e){this._cache.delete(e),this._validation.delete(e)}isValid(e){return this._validation.has(e)}invalidate(e){e===void 0?this._validation.clear():this._validation.delete(e)}clear(){this._cache.clear(),this._validation.clear()}},p=class{constructor(e,t){this.sensor=e,this.startEvent=t,this.prevMoveEvent=t,this.moveEvent=t,this.endEvent=null,this.items=[],this.isEnded=!1,this._matrixCache=new f,this._clientOffsetCache=new f}};function m(e,t,n=!1){let{style:r}=e;for(let e in t)r.setProperty(e,t[e],n?`important`:``)}function h(){let e=document.createElement(`div`);return e.classList.add(`dragdoll-measure`),m(e,{display:`block`,position:`absolute`,inset:`0px`,padding:`0px`,margin:`0px`,border:`none`,opacity:`0`,transform:`none`,"transform-origin":`0 0`,transition:`none`,animation:`none`,"pointer-events":`none`},!0),e}function g(e,t={x:0,y:0}){if(t.x=0,t.y=0,e instanceof Window)return t;if(e instanceof Document)return t.x=window.scrollX*-1,t.y=window.scrollY*-1,t;let{x:r,y:i}=e.getBoundingClientRect(),a=n(e);return t.x=r+(parseFloat(a.borderLeftWidth)||0),t.y=i+(parseFloat(a.borderTopWidth)||0),t}function _(e){let t=n(e),r=parseFloat(t.height)||0;return t.boxSizing===`border-box`?r:(r+=parseFloat(t.borderTopWidth)||0,r+=parseFloat(t.borderBottomWidth)||0,r+=parseFloat(t.paddingTop)||0,r+=parseFloat(t.paddingBottom)||0,e instanceof HTMLElement&&(r+=e.offsetHeight-e.clientHeight),r)}function v(e){let t=n(e),r=parseFloat(t.width)||0;return t.boxSizing===`border-box`?r:(r+=parseFloat(t.borderLeftWidth)||0,r+=parseFloat(t.borderRightWidth)||0,r+=parseFloat(t.paddingLeft)||0,r+=parseFloat(t.paddingRight)||0,e instanceof HTMLElement&&(r+=e.offsetWidth-e.clientWidth),r)}function y(e,t=!1){let{translate:r,rotate:i,scale:a,transform:o}=n(e),s=``;if(r&&r!==`none`){let[t=`0px`,n=`0px`,i]=r.split(` `);t.includes(`%`)&&(t=`${parseFloat(t)/100*v(e)}px`),n.includes(`%`)&&(n=`${parseFloat(n)/100*_(e)}px`),i?s+=`translate3d(${t},${n},${i})`:s+=`translate(${t},${n})`}if(i&&i!==`none`){let e=i.split(` `);e.length>1?s+=`rotate3d(${e.join(`,`)})`:s+=`rotate(${e.join(`,`)})`}if(a&&a!==`none`){let e=a.split(` `);e.length===3?s+=`scale3d(${e.join(`,`)})`:s+=`scale(${e.join(`,`)})`}return!t&&o&&o!==`none`&&(s+=o),s}function b(e){return typeof e==`object`&&!!e&&`x`in e&&`y`in e}const x={x:0,y:0},S={x:0,y:0};function C(e,t,n={x:0,y:0}){let r=b(e)?e:g(e,x),i=b(t)?t:g(t,S);return n.x=i.x-r.x,n.y=i.y-r.y,n}function w(e){let t=e.split(` `),n=``,r=``,i=``;return t.length===1?n=r=t[0]:t.length===2?[n,r]=t:[n,r,i]=t,{x:parseFloat(n)||0,y:parseFloat(r)||0,z:parseFloat(i)||0}}const T=r?new DOMMatrix:null;function E(e,t=new DOMMatrix){let r=e;for(u(t);r;){let e=y(r);if(e&&(T.setMatrixValue(e),!T.isIdentity)){let{transformOrigin:e}=n(r),{x:i,y:a,z:o}=w(e);o===0?T.setMatrixValue(`translate(${i}px,${a}px) ${T} translate(${i*-1}px,${a*-1}px)`):T.setMatrixValue(`translate3d(${i}px,${a}px,${o}px) ${T} translate3d(${i*-1}px,${a*-1}px,${o*-1}px)`),t.preMultiplySelf(T)}r=r.parentElement}return t}const D=r?h():null;var O=class{constructor(e,t){if(!e.isConnected)throw Error(`Element is not connected`);let{drag:r}=t;if(!r)throw Error(`Drag is not defined`);let i=n(e),a=e.getBoundingClientRect(),s=y(e,!0);this.data={},this.element=e,this.elementTransformOrigin=w(i.transformOrigin),this.elementTransformMatrix=new DOMMatrix().setMatrixValue(s+i.transform),this.elementOffsetMatrix=new DOMMatrix(s).invertSelf(),this.frozenStyles=null,this.unfrozenStyles=null,this.position={x:0,y:0},this.containerOffset={x:0,y:0},this.alignmentOffset={x:0,y:0},this._moveDiff={x:0,y:0},this._alignDiff={x:0,y:0},this._matrixCache=r._matrixCache,this._clientOffsetCache=r._clientOffsetCache;let c=e.parentElement;if(!c)throw Error(`Dragged element does not have a parent element.`);this.elementContainer=c;let l=t.settings.container||c;if(this.dragContainer=l,c!==l){let{position:e}=i;if(e!==`fixed`&&e!==`absolute`)throw Error(`Dragged element has "${e}" position, but only "fixed" or "absolute" are allowed when using a custom drag container.`)}let u=o(e)||e;this.elementOffsetContainer=u,this.dragOffsetContainer=l===c?u:o(e,{container:l});{let{width:e,height:t,x:n,y:r}=a;this.clientRect={width:e,height:t,x:n,y:r}}this._updateContainerMatrices(),this._updateContainerOffset();let d=t.settings.frozenStyles({draggable:t,drag:r,item:this,style:i});if(Array.isArray(d))if(d.length){let e={};for(let t of d)e[t]=i[t];this.frozenStyles=e}else this.frozenStyles=null;else this.frozenStyles=d;if(this.frozenStyles){let t={};for(let n in this.frozenStyles)t[n]=e.style[n];this.unfrozenStyles=t}}_updateContainerMatrices(){[this.elementContainer,this.dragContainer].forEach(e=>{if(!this._matrixCache.isValid(e)){let t=this._matrixCache.get(e)||[new DOMMatrix,new DOMMatrix],[n,r]=t;E(e,n),r.setMatrixValue(n.toString()).invertSelf(),this._matrixCache.set(e,t)}})}_updateContainerOffset(){let{elementOffsetContainer:e,elementContainer:t,dragOffsetContainer:n,dragContainer:r,containerOffset:i,_clientOffsetCache:a,_matrixCache:o}=this;if(e!==n){let[s,l]=[[r,n],[t,e]].map(([e,t])=>{let n=a.get(t)||{x:0,y:0};if(!a.isValid(t)){let r=o.get(e);t instanceof HTMLElement&&r&&!r[0].isIdentity?c(r[0])?(D.style.setProperty(`transform`,r[1].toString(),`important`),t.append(D),g(D,n),D.remove()):(g(t,n),n.x-=r[0].m41,n.y-=r[0].m42):g(t,n)}return a.set(t,n),n});C(s,l,i)}else i.x=0,i.y=0}getContainerMatrix(){return this._matrixCache.get(this.elementContainer)}getDragContainerMatrix(){return this._matrixCache.get(this.dragContainer)}updateSize(e){if(e)this.clientRect.width=e.width,this.clientRect.height=e.height;else{let{width:e,height:t}=this.element.getBoundingClientRect();this.clientRect.width=e,this.clientRect.height=t}}};const k={capture:!0,passive:!0},A={x:0,y:0},j=r?new DOMMatrix:null,M=r?new DOMMatrix:null;var N=function(e){return e[e.None=0]=`None`,e[e.Init=1]=`Init`,e[e.Prepare=2]=`Prepare`,e[e.FinishPrepare=3]=`FinishPrepare`,e[e.Apply=4]=`Apply`,e[e.FinishApply=5]=`FinishApply`,e}(N||{}),P=function(e){return e[e.Pending=0]=`Pending`,e[e.Resolved=1]=`Resolved`,e[e.Rejected=2]=`Rejected`,e}(P||{});const F={Start:`start`,Move:`move`,End:`end`},I={Immediate:`immediate`,Sampled:`sampled`},L={Start:`start`,StartAlign:`start-align`,Move:`move`,Align:`align`,End:`end`,EndAlign:`end-align`},R={PrepareStart:`preparestart`,Start:`start`,PrepareMove:`preparemove`,Move:`move`,End:`end`,Destroy:`destroy`},z={container:null,startPredicate:()=>!0,elements:()=>null,frozenStyles:()=>null,applyPosition:({item:e,phase:t})=>{let n=t===L.End||t===L.EndAlign,[r,i]=e.getContainerMatrix(),[a,o]=e.getDragContainerMatrix(),{position:s,alignmentOffset:c,containerOffset:l,elementTransformMatrix:d,elementTransformOrigin:f,elementOffsetMatrix:p}=e,{x:m,y:h,z:g}=f,_=!d.isIdentity&&(m!==0||h!==0||g!==0),v=s.x+c.x+l.x,y=s.y+c.y+l.y;u(j),_&&(g===0?j.translateSelf(-m,-h):j.translateSelf(-m,-h,-g)),n?i.isIdentity||j.multiplySelf(i):o.isIdentity||j.multiplySelf(o),u(M).translateSelf(v,y),j.multiplySelf(M),r.isIdentity||j.multiplySelf(r),_&&(u(M).translateSelf(m,h,g),j.multiplySelf(M)),d.isIdentity||j.multiplySelf(d),p.isIdentity||j.preMultiplySelf(p),e.element.style.transform=`${j}`},computeClientRect:({drag:e})=>e.items[0].clientRect||null,positionModifiers:[],sensorProcessingMode:I.Sampled,dndGroups:new Set};var B=class{constructor(e,t={}){let{id:n=Symbol(),...r}=t;this.id=n,this.sensors=e,this.settings=this._parseSettings(r),this.plugins={},this.drag=null,this.isDestroyed=!1,this._sensorData=new Map,this._emitter=new a,this._startPhase=N.None,this._startId=Symbol(),this._moveId=Symbol(),this._alignId=Symbol(),this._onMove=this._onMove.bind(this),this._onScroll=this._onScroll.bind(this),this._onEnd=this._onEnd.bind(this),this._prepareStart=this._prepareStart.bind(this),this._applyStart=this._applyStart.bind(this),this._prepareMove=this._prepareMove.bind(this),this._applyMove=this._applyMove.bind(this),this._prepareAlign=this._prepareAlign.bind(this),this._applyAlign=this._applyAlign.bind(this),this.sensors.forEach(e=>{this._sensorData.set(e,{predicateState:P.Pending,predicateEvent:null,onMove:t=>this._onMove(t,e),onEnd:t=>this._onEnd(t,e)});let{onMove:t,onEnd:n}=this._sensorData.get(e);e.on(i.Start,t,t),e.on(i.Move,t,t),e.on(i.Cancel,n,n),e.on(i.End,n,n),e.on(i.Destroy,n,n)})}_parseSettings(e,t=z){let{container:n=t.container,startPredicate:r=t.startPredicate,elements:i=t.elements,frozenStyles:a=t.frozenStyles,positionModifiers:o=t.positionModifiers,applyPosition:s=t.applyPosition,computeClientRect:c=t.computeClientRect,sensorProcessingMode:l=t.sensorProcessingMode,dndGroups:u=t.dndGroups,onPrepareStart:d=t.onPrepareStart,onStart:f=t.onStart,onPrepareMove:p=t.onPrepareMove,onMove:m=t.onMove,onEnd:h=t.onEnd,onDestroy:g=t.onDestroy}=e||{};return{container:n,startPredicate:r,elements:i,frozenStyles:a,positionModifiers:o,applyPosition:s,computeClientRect:c,sensorProcessingMode:l,dndGroups:u,onPrepareStart:d,onStart:f,onPrepareMove:p,onMove:m,onEnd:h,onDestroy:g}}_emit(e,...t){this._emitter.emit(e,...t)}_onMove(n,r){let i=this._sensorData.get(r);if(i)switch(i.predicateState){case P.Pending:{i.predicateEvent=n;let e=this.settings.startPredicate({draggable:this,sensor:r,event:n});e===!0?this.resolveStartPredicate(r):e===!1&&this.rejectStartPredicate(r);break}case P.Resolved:this.drag&&(this.drag.moveEvent=n,this.settings.sensorProcessingMode===I.Immediate?(this._prepareMove(),this._applyMove()):(e.once(t.read,this._prepareMove,this._moveId),e.once(t.write,this._applyMove,this._moveId)));break}}_onScroll(){this.align()}_onEnd(e,t){let n=this._sensorData.get(t);n&&(this.drag?n.predicateState===P.Resolved&&(this.drag.endEvent=e,this._sensorData.forEach(e=>{e.predicateState=P.Pending,e.predicateEvent=null}),this.stop()):(n.predicateState=P.Pending,n.predicateEvent=null))}_prepareStart(){let e=this.drag;e&&(this._startPhase=N.Prepare,e.items=(this.settings.elements({draggable:this,drag:e})||[]).map(e=>new O(e,this)),this._applyModifiers(F.Start,0,0),this._emit(R.PrepareStart,e.startEvent),this.settings.onPrepareStart?.(e,this),this._startPhase=N.FinishPrepare)}_applyStart(){let e=this.drag;if(e){this._startPhase=N.Apply;for(let t of e.items)t.dragContainer!==t.elementContainer&&l(t.dragContainer,t.element),t.frozenStyles&&Object.assign(t.element.style,t.frozenStyles),this.settings.applyPosition({phase:L.Start,draggable:this,drag:e,item:t});for(let t of e.items){let e=t.getContainerMatrix()[0],n=t.getDragContainerMatrix()[0];if(s(e,n)||!c(e)&&!c(n))continue;let r=t.element.getBoundingClientRect(),{alignmentOffset:i}=t;i.x+=d(t.clientRect.x-r.x,3),i.y+=d(t.clientRect.y-r.y,3)}for(let t of e.items){let{alignmentOffset:n}=t;(n.x!==0||n.y!==0)&&this.settings.applyPosition({phase:L.StartAlign,draggable:this,drag:e,item:t})}window.addEventListener(`scroll`,this._onScroll,k),this._emit(R.Start,e.startEvent),this.settings.onStart?.(e,this),this._startPhase=N.FinishApply}}_prepareMove(){let e=this.drag;if(!e)return;let{moveEvent:t,prevMoveEvent:n}=e;t!==n&&(this._applyModifiers(F.Move,t.x-n.x,t.y-n.y),this._emit(R.PrepareMove,t),!e.isEnded&&(this.settings.onPrepareMove?.(e,this),!e.isEnded&&(e.prevMoveEvent=t)))}_applyMove(){let e=this.drag;if(e){for(let t of e.items)t._moveDiff.x=0,t._moveDiff.y=0,this.settings.applyPosition({phase:L.Move,draggable:this,drag:e,item:t});this._emit(R.Move,e.moveEvent),!e.isEnded&&this.settings.onMove?.(e,this)}}_prepareAlign(){let{drag:e}=this;if(e)for(let t of e.items){let{x:e,y:n}=t.element.getBoundingClientRect(),r=t.clientRect.x-t._moveDiff.x-e;t.alignmentOffset.x=t.alignmentOffset.x-t._alignDiff.x+r,t._alignDiff.x=r;let i=t.clientRect.y-t._moveDiff.y-n;t.alignmentOffset.y=t.alignmentOffset.y-t._alignDiff.y+i,t._alignDiff.y=i}}_applyAlign(){let{drag:e}=this;if(e)for(let t of e.items)t._alignDiff.x=0,t._alignDiff.y=0,this.settings.applyPosition({phase:L.Align,draggable:this,drag:e,item:t})}_applyModifiers(e,t,n){let{drag:r}=this;if(!r)return;let{positionModifiers:i}=this.settings;for(let a of r.items){let o=A;o.x=t,o.y=n;for(let t of i)o=t(o,{draggable:this,drag:r,item:a,phase:e});a.position.x+=o.x,a.position.y+=o.y,a.clientRect.x+=o.x,a.clientRect.y+=o.y,e===`move`&&(a._moveDiff.x+=o.x,a._moveDiff.y+=o.y)}}on(e,t,n){return this._emitter.on(e,t,n)}off(e,t){this._emitter.off(e,t)}resolveStartPredicate(n,r){let i=this._sensorData.get(n);if(!i)return;let a=r||i.predicateEvent;i.predicateState===P.Pending&&a&&(this._startPhase=N.Init,i.predicateState=P.Resolved,i.predicateEvent=null,this.drag=new p(n,a),this._sensorData.forEach((e,t)=>{t!==n&&(e.predicateState=P.Rejected,e.predicateEvent=null)}),this.settings.sensorProcessingMode===I.Immediate?(this._prepareStart(),this._applyStart()):(e.once(t.read,this._prepareStart,this._startId),e.once(t.write,this._applyStart,this._startId)))}rejectStartPredicate(e){let t=this._sensorData.get(e);t?.predicateState===P.Pending&&(t.predicateState=P.Rejected,t.predicateEvent=null)}stop(){let n=this.drag;if(!(!n||n.isEnded)){if(this._startPhase===N.Prepare||this._startPhase===N.Apply)throw Error(`Cannot stop drag start process at this point`);n.isEnded=!0,this._startPhase===N.Init&&this._prepareStart(),this._startPhase===N.FinishPrepare&&this._applyStart(),this._startPhase=N.None,e.off(t.read,this._startId),e.off(t.write,this._startId),e.off(t.read,this._moveId),e.off(t.write,this._moveId),e.off(t.read,this._alignId),e.off(t.write,this._alignId),window.removeEventListener(`scroll`,this._onScroll,k),this._applyModifiers(F.End,0,0);for(let e of n.items){if(e.elementContainer!==e.dragContainer&&(l(e.elementContainer,e.element),e.alignmentOffset.x=0,e.alignmentOffset.y=0,e.containerOffset.x=0,e.containerOffset.y=0),e.unfrozenStyles)for(let t in e.unfrozenStyles)e.element.style[t]=e.unfrozenStyles[t]||``;this.settings.applyPosition({phase:L.End,draggable:this,drag:n,item:e})}for(let e of n.items)if(e.elementContainer!==e.dragContainer){let t=e.element.getBoundingClientRect();e.alignmentOffset.x=d(e.clientRect.x-t.x,3),e.alignmentOffset.y=d(e.clientRect.y-t.y,3)}for(let e of n.items)e.elementContainer!==e.dragContainer&&(e.alignmentOffset.x!==0||e.alignmentOffset.y!==0)&&this.settings.applyPosition({phase:L.EndAlign,draggable:this,drag:n,item:e});this._emit(R.End,n.endEvent),this.settings.onEnd?.(n,this),this.drag=null}}align(n=!1){this.drag&&(n||this.settings.sensorProcessingMode===I.Immediate?(this._prepareAlign(),this._applyAlign()):(e.once(t.read,this._prepareAlign,this._alignId),e.once(t.write,this._applyAlign,this._alignId)))}getClientRect(){let{drag:e,settings:t}=this;return e&&t.computeClientRect?.({draggable:this,drag:e})||null}updateSettings(e={}){this.settings=this._parseSettings(e,this.settings)}use(e){return e(this)}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.stop(),this._sensorData.forEach(({onMove:e,onEnd:t},n)=>{n.off(i.Start,e),n.off(i.Move,e),n.off(i.Cancel,t),n.off(i.End,t),n.off(i.Destroy,t)}),this._sensorData.clear(),this._emit(R.Destroy),this.settings.onDestroy?.(this),this._emitter.off())}};export{B as Draggable,L as DraggableApplyPositionPhase,z as DraggableDefaultSettings,p as DraggableDrag,O as DraggableDragItem,R as DraggableEventType,F as DraggableModifierPhase,I as DraggableSensorProcessingMode};
//# sourceMappingURL=draggable-C1QBodX1.js.map