import{SensorEventType as e}from"./sensor-TzqXogk2.js";import{ticker as t,tickerPhases as n}from"./ticker-EaCO7G8S.js";import{IS_BROWSER as r}from"./constants-BG0DGMmK.js";import{getStyle as i}from"./get-style-e3zfxW9-.js";import{Emitter as a}from"eventti";import{getOffsetContainer as o}from"mezr/getOffsetContainer";function s(e,t){return e.isIdentity&&t.isIdentity?!0:e.is2D&&t.is2D?e.a===t.a&&e.b===t.b&&e.c===t.c&&e.d===t.d&&e.e===t.e&&e.f===t.f:e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m21===t.m21&&e.m22===t.m22&&e.m23===t.m23&&e.m24===t.m24&&e.m31===t.m31&&e.m32===t.m32&&e.m33===t.m33&&e.m34===t.m34&&e.m41===t.m41&&e.m42===t.m42&&e.m43===t.m43&&e.m44===t.m44}function c(e){return e.m11!==1||e.m12!==0||e.m13!==0||e.m14!==0||e.m21!==0||e.m22!==1||e.m23!==0||e.m24!==0||e.m31!==0||e.m32!==0||e.m33!==1||e.m34!==0||e.m43!==0||e.m44!==1}function l(e,t,n=null){if(`moveBefore`in e&&e.isConnected===t.isConnected)try{e.moveBefore(t,n);return}catch{}let r=document.activeElement,i=t.contains(r);e.insertBefore(t,n),i&&document.activeElement!==r&&r instanceof HTMLElement&&r.focus({preventScroll:!0})}function u(e){return e.setMatrixValue(`scale(1, 1)`)}function d(e,t=0){let n=10**t;return Math.round((e+2**-52)*n)/n}var f=class{constructor(){this._cache=new Map,this._validation=new Map}set(e,t){this._cache.set(e,t),this._validation.set(e,void 0)}get(e){return this._cache.get(e)}has(e){return this._cache.has(e)}delete(e){this._cache.delete(e),this._validation.delete(e)}isValid(e){return this._validation.has(e)}invalidate(e){e===void 0?this._validation.clear():this._validation.delete(e)}clear(){this._cache.clear(),this._validation.clear()}},p=class{constructor(e,t){this.sensor=e,this.startEvent=t,this.prevMoveEvent=t,this.moveEvent=t,this.endEvent=null,this.items=[],this.isEnded=!1,this._matrixCache=new f,this._clientOffsetCache=new f}};function m(e,t,n=!1){let{style:r}=e;for(let e in t)r.setProperty(e,t[e],n?`important`:``)}function h(){let e=document.createElement(`div`);return e.classList.add(`dragdoll-measure`),m(e,{display:`block`,position:`absolute`,inset:`0px`,padding:`0px`,margin:`0px`,border:`none`,opacity:`0`,transform:`none`,"transform-origin":`0 0`,transition:`none`,animation:`none`,"pointer-events":`none`},!0),e}function g(e,t={x:0,y:0}){if(t.x=0,t.y=0,e instanceof Window)return t;if(e instanceof Document)return t.x=window.scrollX*-1,t.y=window.scrollY*-1,t;let{x:n,y:r}=e.getBoundingClientRect(),a=i(e);return t.x=n+(parseFloat(a.borderLeftWidth)||0),t.y=r+(parseFloat(a.borderTopWidth)||0),t}function _(e){let t=i(e),n=parseFloat(t.height)||0;return t.boxSizing===`border-box`?n:(n+=parseFloat(t.borderTopWidth)||0,n+=parseFloat(t.borderBottomWidth)||0,n+=parseFloat(t.paddingTop)||0,n+=parseFloat(t.paddingBottom)||0,e instanceof HTMLElement&&(n+=e.offsetHeight-e.clientHeight),n)}function v(e){let t=i(e),n=parseFloat(t.width)||0;return t.boxSizing===`border-box`?n:(n+=parseFloat(t.borderLeftWidth)||0,n+=parseFloat(t.borderRightWidth)||0,n+=parseFloat(t.paddingLeft)||0,n+=parseFloat(t.paddingRight)||0,e instanceof HTMLElement&&(n+=e.offsetWidth-e.clientWidth),n)}function y(e,t=!1){let{translate:n,rotate:r,scale:a,transform:o}=i(e),s=``;if(n&&n!==`none`){let[t=`0px`,r=`0px`,i]=n.split(` `);t.includes(`%`)&&(t=`${parseFloat(t)/100*v(e)}px`),r.includes(`%`)&&(r=`${parseFloat(r)/100*_(e)}px`),i?s+=`translate3d(${t},${r},${i})`:s+=`translate(${t},${r})`}if(r&&r!==`none`){let e=r.split(` `);e.length>1?s+=`rotate3d(${e.join(`,`)})`:s+=`rotate(${e.join(`,`)})`}if(a&&a!==`none`){let e=a.split(` `);e.length===3?s+=`scale3d(${e.join(`,`)})`:s+=`scale(${e.join(`,`)})`}return!t&&o&&o!==`none`&&(s+=o),s}function b(e){return typeof e==`object`&&!!e&&`x`in e&&`y`in e}const x={x:0,y:0},S={x:0,y:0};function C(e,t,n={x:0,y:0}){let r=b(e)?e:g(e,x),i=b(t)?t:g(t,S);return n.x=i.x-r.x,n.y=i.y-r.y,n}function w(e){let t=e.split(` `),n=``,r=``,i=``;return t.length===1?n=r=t[0]:t.length===2?[n,r]=t:[n,r,i]=t,{x:parseFloat(n)||0,y:parseFloat(r)||0,z:parseFloat(i)||0}}const T=r?new DOMMatrix:null;function E(e,t=new DOMMatrix){let n=e;for(u(t);n;){let e=y(n);if(e&&(T.setMatrixValue(e),!T.isIdentity)){let{transformOrigin:e}=i(n),{x:r,y:a,z:o}=w(e);o===0?T.setMatrixValue(`translate(${r}px,${a}px) ${T} translate(${r*-1}px,${a*-1}px)`):T.setMatrixValue(`translate3d(${r}px,${a}px,${o}px) ${T} translate3d(${r*-1}px,${a*-1}px,${o*-1}px)`),t.preMultiplySelf(T)}n=n.parentElement}return t}const D=r?h():null;var O=class{constructor(e,t){if(!e.isConnected)throw Error(`Element is not connected`);let{drag:n}=t;if(!n)throw Error(`Drag is not defined`);let r=i(e),a=e.getBoundingClientRect(),s=y(e,!0);this.data={},this.element=e,this.elementTransformOrigin=w(r.transformOrigin),this.elementTransformMatrix=new DOMMatrix().setMatrixValue(s+r.transform),this.elementOffsetMatrix=new DOMMatrix(s).invertSelf(),this.frozenStyles=null,this.unfrozenStyles=null,this.position={x:0,y:0},this.containerOffset={x:0,y:0},this.alignmentOffset={x:0,y:0},this._moveDiff={x:0,y:0},this._alignDiff={x:0,y:0},this._matrixCache=n._matrixCache,this._clientOffsetCache=n._clientOffsetCache;let c=e.parentElement;if(!c)throw Error(`Dragged element does not have a parent element.`);this.elementContainer=c;let l=t.settings.container||c;if(this.dragContainer=l,c!==l){let{position:e}=r;if(e!==`fixed`&&e!==`absolute`)throw Error(`Dragged element has "${e}" position, but only "fixed" or "absolute" are allowed when using a custom drag container.`)}let u=o(e)||e;this.elementOffsetContainer=u,this.dragOffsetContainer=l===c?u:o(e,{container:l});{let{width:e,height:t,x:n,y:r}=a;this.clientRect={width:e,height:t,x:n,y:r}}this._updateContainerMatrices(),this._updateContainerOffset();let d=t.settings.frozenStyles({draggable:t,drag:n,item:this,style:r});if(Array.isArray(d))if(d.length){let e={};for(let t of d)e[t]=r[t];this.frozenStyles=e}else this.frozenStyles=null;else this.frozenStyles=d;if(this.frozenStyles){let t={};for(let n in this.frozenStyles)t[n]=e.style[n];this.unfrozenStyles=t}}_updateContainerMatrices(){[this.elementContainer,this.dragContainer].forEach(e=>{if(!this._matrixCache.isValid(e)){let t=this._matrixCache.get(e)||[new DOMMatrix,new DOMMatrix],[n,r]=t;E(e,n),r.setMatrixValue(n.toString()).invertSelf(),this._matrixCache.set(e,t)}})}_updateContainerOffset(){let{elementOffsetContainer:e,elementContainer:t,dragOffsetContainer:n,dragContainer:r,containerOffset:i,_clientOffsetCache:a,_matrixCache:o}=this;if(e!==n){let[s,l]=[[r,n],[t,e]].map(([e,t])=>{let n=a.get(t)||{x:0,y:0};if(!a.isValid(t)){let r=o.get(e);t instanceof HTMLElement&&r&&!r[0].isIdentity?c(r[0])?(D.style.setProperty(`transform`,r[1].toString(),`important`),t.append(D),g(D,n),D.remove()):(g(t,n),n.x-=r[0].m41,n.y-=r[0].m42):g(t,n)}return a.set(t,n),n});C(s,l,i)}else i.x=0,i.y=0}getContainerMatrix(){return this._matrixCache.get(this.elementContainer)}getDragContainerMatrix(){return this._matrixCache.get(this.dragContainer)}updateSize(e){if(e)this.clientRect.width=e.width,this.clientRect.height=e.height;else{let{width:e,height:t}=this.element.getBoundingClientRect();this.clientRect.width=e,this.clientRect.height=t}}};const k={capture:!0,passive:!0},A={x:0,y:0},j=r?new DOMMatrix:null,M=r?new DOMMatrix:null;var N=function(e){return e[e.None=0]=`None`,e[e.Init=1]=`Init`,e[e.Prepare=2]=`Prepare`,e[e.FinishPrepare=3]=`FinishPrepare`,e[e.Apply=4]=`Apply`,e[e.FinishApply=5]=`FinishApply`,e}(N||{}),P=function(e){return e[e.Pending=0]=`Pending`,e[e.Resolved=1]=`Resolved`,e[e.Rejected=2]=`Rejected`,e}(P||{});const F={Start:`start`,Move:`move`,End:`end`},I={Start:`start`,StartAlign:`start-align`,Move:`move`,Align:`align`,End:`end`,EndAlign:`end-align`},L={PrepareStart:`preparestart`,Start:`start`,PrepareMove:`preparemove`,Move:`move`,End:`end`,Destroy:`destroy`},R={container:null,startPredicate:()=>!0,elements:()=>null,frozenStyles:()=>null,applyPosition:({item:e,phase:t})=>{let n=t===I.End||t===I.EndAlign,[r,i]=e.getContainerMatrix(),[a,o]=e.getDragContainerMatrix(),{position:s,alignmentOffset:c,containerOffset:l,elementTransformMatrix:d,elementTransformOrigin:f,elementOffsetMatrix:p}=e,{x:m,y:h,z:g}=f,_=!d.isIdentity&&(m!==0||h!==0||g!==0),v=s.x+c.x+l.x,y=s.y+c.y+l.y;u(j),_&&(g===0?j.translateSelf(-m,-h):j.translateSelf(-m,-h,-g)),n?i.isIdentity||j.multiplySelf(i):o.isIdentity||j.multiplySelf(o),u(M).translateSelf(v,y),j.multiplySelf(M),r.isIdentity||j.multiplySelf(r),_&&(u(M).translateSelf(m,h,g),j.multiplySelf(M)),d.isIdentity||j.multiplySelf(d),p.isIdentity||j.preMultiplySelf(p),e.element.style.transform=`${j}`},computeClientRect:({drag:e})=>e.items[0].clientRect||null,positionModifiers:[],group:null};var z=class{constructor(t,n={}){let{id:r=Symbol(),...i}=n;this.id=r,this.sensors=t,this.settings=this._parseSettings(i),this.plugins={},this.drag=null,this.isDestroyed=!1,this._sensorData=new Map,this._emitter=new a,this._startPhase=N.None,this._startId=Symbol(),this._moveId=Symbol(),this._alignId=Symbol(),this._onMove=this._onMove.bind(this),this._onScroll=this._onScroll.bind(this),this._onEnd=this._onEnd.bind(this),this._prepareStart=this._prepareStart.bind(this),this._applyStart=this._applyStart.bind(this),this._prepareMove=this._prepareMove.bind(this),this._applyMove=this._applyMove.bind(this),this._prepareAlign=this._prepareAlign.bind(this),this._applyAlign=this._applyAlign.bind(this),this.sensors.forEach(t=>{this._sensorData.set(t,{predicateState:P.Pending,predicateEvent:null,onMove:e=>this._onMove(e,t),onEnd:e=>this._onEnd(e,t)});let{onMove:n,onEnd:r}=this._sensorData.get(t);t.on(e.Start,n,n),t.on(e.Move,n,n),t.on(e.Cancel,r,r),t.on(e.End,r,r),t.on(e.Destroy,r,r)})}_parseSettings(e,t=R){let{container:n=t.container,startPredicate:r=t.startPredicate,elements:i=t.elements,frozenStyles:a=t.frozenStyles,positionModifiers:o=t.positionModifiers,applyPosition:s=t.applyPosition,computeClientRect:c=t.computeClientRect,group:l=t.group,onPrepareStart:u=t.onPrepareStart,onStart:d=t.onStart,onPrepareMove:f=t.onPrepareMove,onMove:p=t.onMove,onEnd:m=t.onEnd,onDestroy:h=t.onDestroy}=e||{};return{container:n,startPredicate:r,elements:i,frozenStyles:a,positionModifiers:o,applyPosition:s,computeClientRect:c,group:l,onPrepareStart:u,onStart:d,onPrepareMove:f,onMove:p,onEnd:m,onDestroy:h}}_emit(e,...t){this._emitter.emit(e,...t)}_onMove(e,r){let i=this._sensorData.get(r);if(i)switch(i.predicateState){case P.Pending:{i.predicateEvent=e;let t=this.settings.startPredicate({draggable:this,sensor:r,event:e});t===!0?this.resolveStartPredicate(r):t===!1&&this.rejectStartPredicate(r);break}case P.Resolved:this.drag&&(this.drag.moveEvent=e,t.once(n.read,this._prepareMove,this._moveId),t.once(n.write,this._applyMove,this._moveId));break}}_onScroll(){this.align()}_onEnd(e,t){let n=this._sensorData.get(t);n&&(this.drag?n.predicateState===P.Resolved&&(this.drag.endEvent=e,this._sensorData.forEach(e=>{e.predicateState=P.Pending,e.predicateEvent=null}),this.stop()):(n.predicateState=P.Pending,n.predicateEvent=null))}_prepareStart(){let e=this.drag;e&&(this._startPhase=N.Prepare,e.items=(this.settings.elements({draggable:this,drag:e})||[]).map(e=>new O(e,this)),this._applyModifiers(F.Start,0,0),this._emit(L.PrepareStart,e.startEvent),this.settings.onPrepareStart?.(e,this),this._startPhase=N.FinishPrepare)}_applyStart(){let e=this.drag;if(e){this._startPhase=N.Apply;for(let t of e.items)t.dragContainer!==t.elementContainer&&l(t.dragContainer,t.element),t.frozenStyles&&Object.assign(t.element.style,t.frozenStyles),this.settings.applyPosition({phase:I.Start,draggable:this,drag:e,item:t});for(let t of e.items){let e=t.getContainerMatrix()[0],n=t.getDragContainerMatrix()[0];if(s(e,n)||!c(e)&&!c(n))continue;let r=t.element.getBoundingClientRect(),{alignmentOffset:i}=t;i.x+=d(t.clientRect.x-r.x,3),i.y+=d(t.clientRect.y-r.y,3)}for(let t of e.items){let{alignmentOffset:n}=t;(n.x!==0||n.y!==0)&&this.settings.applyPosition({phase:I.StartAlign,draggable:this,drag:e,item:t})}window.addEventListener(`scroll`,this._onScroll,k),this._emit(L.Start,e.startEvent),this.settings.onStart?.(e,this),this._startPhase=N.FinishApply}}_prepareMove(){let e=this.drag;if(!e)return;let{moveEvent:t,prevMoveEvent:n}=e;t!==n&&(this._applyModifiers(F.Move,t.x-n.x,t.y-n.y),this._emit(L.PrepareMove,t),!e.isEnded&&(this.settings.onPrepareMove?.(e,this),!e.isEnded&&(e.prevMoveEvent=t)))}_applyMove(){let e=this.drag;if(e){for(let t of e.items)t._moveDiff.x=0,t._moveDiff.y=0,this.settings.applyPosition({phase:I.Move,draggable:this,drag:e,item:t});this._emit(L.Move,e.moveEvent),!e.isEnded&&this.settings.onMove?.(e,this)}}_prepareAlign(){let{drag:e}=this;if(e)for(let t of e.items){let{x:e,y:n}=t.element.getBoundingClientRect(),r=t.clientRect.x-t._moveDiff.x-e;t.alignmentOffset.x=t.alignmentOffset.x-t._alignDiff.x+r,t._alignDiff.x=r;let i=t.clientRect.y-t._moveDiff.y-n;t.alignmentOffset.y=t.alignmentOffset.y-t._alignDiff.y+i,t._alignDiff.y=i}}_applyAlign(){let{drag:e}=this;if(e)for(let t of e.items)t._alignDiff.x=0,t._alignDiff.y=0,this.settings.applyPosition({phase:I.Align,draggable:this,drag:e,item:t})}_applyModifiers(e,t,n){let{drag:r}=this;if(!r)return;let{positionModifiers:i}=this.settings;for(let a of r.items){let o=A;o.x=t,o.y=n;for(let t of i)o=t(o,{draggable:this,drag:r,item:a,phase:e});a.position.x+=o.x,a.position.y+=o.y,a.clientRect.x+=o.x,a.clientRect.y+=o.y,e===`move`&&(a._moveDiff.x+=o.x,a._moveDiff.y+=o.y)}}on(e,t,n){return this._emitter.on(e,t,n)}off(e,t){this._emitter.off(e,t)}resolveStartPredicate(e,r){let i=this._sensorData.get(e);if(!i)return;let a=r||i.predicateEvent;i.predicateState===P.Pending&&a&&(this._startPhase=N.Init,i.predicateState=P.Resolved,i.predicateEvent=null,this.drag=new p(e,a),this._sensorData.forEach((t,n)=>{n!==e&&(t.predicateState=P.Rejected,t.predicateEvent=null)}),t.once(n.read,this._prepareStart,this._startId),t.once(n.write,this._applyStart,this._startId))}rejectStartPredicate(e){let t=this._sensorData.get(e);t?.predicateState===P.Pending&&(t.predicateState=P.Rejected,t.predicateEvent=null)}stop(){let e=this.drag;if(!e||e.isEnded)return;let r=this._startPhase;if(r===N.Prepare||r===N.Apply)throw Error(`Cannot stop drag start process at this point`);if(this._startPhase=N.None,e.isEnded=!0,t.off(n.read,this._startId),t.off(n.write,this._startId),t.off(n.read,this._moveId),t.off(n.write,this._moveId),t.off(n.read,this._alignId),t.off(n.write,this._alignId),window.removeEventListener(`scroll`,this._onScroll,k),r>N.Init&&this._applyModifiers(F.End,0,0),r===N.FinishApply){for(let t of e.items){if(t.elementContainer!==t.dragContainer&&(l(t.elementContainer,t.element),t.alignmentOffset.x=0,t.alignmentOffset.y=0,t.containerOffset.x=0,t.containerOffset.y=0),t.unfrozenStyles)for(let e in t.unfrozenStyles)t.element.style[e]=t.unfrozenStyles[e]||``;this.settings.applyPosition({phase:I.End,draggable:this,drag:e,item:t})}for(let t of e.items)if(t.elementContainer!==t.dragContainer){let e=t.element.getBoundingClientRect();t.alignmentOffset.x=d(t.clientRect.x-e.x,3),t.alignmentOffset.y=d(t.clientRect.y-e.y,3)}for(let t of e.items)t.elementContainer!==t.dragContainer&&(t.alignmentOffset.x!==0||t.alignmentOffset.y!==0)&&this.settings.applyPosition({phase:I.EndAlign,draggable:this,drag:e,item:t})}else if(r===N.FinishPrepare)for(let t of e.items)t.clientRect.x-=t.position.x,t.clientRect.y-=t.position.y,t.position.x=0,t.position.y=0,t.elementContainer!==t.dragContainer&&(t.alignmentOffset.x=0,t.alignmentOffset.y=0,t.containerOffset.x=0,t.containerOffset.y=0);this._emit(L.End,e.endEvent),this.settings.onEnd?.(e,this),this.drag=null}align(e=!1){this.drag&&(e?(this._prepareAlign(),this._applyAlign()):(t.once(n.read,this._prepareAlign,this._alignId),t.once(n.write,this._applyAlign,this._alignId)))}getClientRect(){let{drag:e,settings:t}=this;return e&&t.computeClientRect?.({draggable:this,drag:e})||null}updateSettings(e={}){this.settings=this._parseSettings(e,this.settings)}use(e){return e(this)}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.stop(),this._sensorData.forEach(({onMove:t,onEnd:n},r)=>{r.off(e.Start,t),r.off(e.Move,t),r.off(e.Cancel,n),r.off(e.End,n),r.off(e.Destroy,n)}),this._sensorData.clear(),this._emit(L.Destroy),this.settings.onDestroy?.(this),this._emitter.off())}};export{z as Draggable,I as DraggableApplyPositionPhase,R as DraggableDefaultSettings,p as DraggableDrag,O as DraggableDragItem,L as DraggableEventType,F as DraggableModifierPhase};
//# sourceMappingURL=draggable-qBrB_jQL.js.map