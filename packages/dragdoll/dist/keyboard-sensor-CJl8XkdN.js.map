{"version":3,"file":"keyboard-sensor-CJl8XkdN.js","names":["keyboardSensorDefaults: KeyboardSensorSettings<any>"],"sources":["../src/sensors/keyboard-sensor.ts"],"sourcesContent":["import type { Point } from '../types.js';\nimport { BaseSensor } from './base-sensor.js';\nimport type {\n  Sensor,\n  SensorCancelEvent,\n  SensorDestroyEvent,\n  SensorEndEvent,\n  SensorMoveEvent,\n  SensorStartEvent,\n} from './sensor.js';\nimport { SensorEventType } from './sensor.js';\n\nexport type KeyboardSensorPredicate<E extends KeyboardSensorEvents = KeyboardSensorEvents> = (\n  e: KeyboardEvent,\n  sensor: KeyboardSensor<E>,\n) => Point | null | undefined;\n\nexport interface KeyboardSensorSettings<E extends KeyboardSensorEvents = KeyboardSensorEvents> {\n  moveDistance: number | Point;\n  cancelOnBlur: boolean;\n  cancelOnVisibilityChange: boolean;\n  startPredicate: KeyboardSensorPredicate<E>;\n  movePredicate: KeyboardSensorPredicate<E>;\n  cancelPredicate: KeyboardSensorPredicate<E>;\n  endPredicate: KeyboardSensorPredicate<E>;\n}\n\nexport interface KeyboardSensorStartEvent extends SensorStartEvent {\n  srcEvent: KeyboardEvent;\n}\n\nexport interface KeyboardSensorMoveEvent extends SensorMoveEvent {\n  srcEvent: KeyboardEvent;\n}\n\nexport interface KeyboardSensorCancelEvent extends SensorCancelEvent {\n  srcEvent?: KeyboardEvent;\n}\n\nexport interface KeyboardSensorEndEvent extends SensorEndEvent {\n  srcEvent: KeyboardEvent;\n}\n\nexport interface KeyboardSensorDestroyEvent extends SensorDestroyEvent {}\n\nexport interface KeyboardSensorEvents {\n  start: KeyboardSensorStartEvent;\n  move: KeyboardSensorMoveEvent;\n  cancel: KeyboardSensorCancelEvent;\n  end: KeyboardSensorEndEvent;\n  destroy: KeyboardSensorDestroyEvent;\n}\n\nexport const keyboardSensorDefaults: KeyboardSensorSettings<any> = {\n  moveDistance: 25,\n  cancelOnBlur: true,\n  cancelOnVisibilityChange: true,\n  startPredicate: (e, sensor) => {\n    if (sensor.element && (e.key === 'Enter' || e.key === ' ')) {\n      if (document.activeElement === sensor.element) {\n        const { x, y } = sensor.element.getBoundingClientRect();\n        return { x, y };\n      }\n    }\n    return null;\n  },\n  movePredicate: (e, sensor) => {\n    if (!sensor.drag) return null;\n\n    switch (e.key) {\n      case 'ArrowLeft': {\n        return {\n          x: sensor.drag.x - sensor.moveDistance.x,\n          y: sensor.drag.y,\n        };\n      }\n      case 'ArrowRight': {\n        return {\n          x: sensor.drag.x + sensor.moveDistance.x,\n          y: sensor.drag.y,\n        };\n      }\n      case 'ArrowUp': {\n        return {\n          x: sensor.drag.x,\n          y: sensor.drag.y - sensor.moveDistance.y,\n        };\n      }\n      case 'ArrowDown': {\n        return {\n          x: sensor.drag.x,\n          y: sensor.drag.y + sensor.moveDistance.y,\n        };\n      }\n      default: {\n        return null;\n      }\n    }\n  },\n  cancelPredicate: (e, sensor) => {\n    if (sensor.drag && e.key === 'Escape') {\n      const { x, y } = sensor.drag;\n      return { x, y };\n    }\n    return null;\n  },\n  endPredicate: (e, sensor) => {\n    if (sensor.drag && (e.key === 'Enter' || e.key === ' ')) {\n      const { x, y } = sensor.drag;\n      return { x, y };\n    }\n    return null;\n  },\n} as const;\n\nexport class KeyboardSensor<E extends KeyboardSensorEvents = KeyboardSensorEvents>\n  extends BaseSensor<E>\n  implements Sensor<E>\n{\n  declare _events_type: E;\n  readonly element: Element | null;\n  readonly moveDistance: Point;\n  protected _cancelOnBlur: boolean;\n  protected _cancelOnVisibilityChange: boolean;\n  protected _startPredicate: KeyboardSensorPredicate<E>;\n  protected _movePredicate: KeyboardSensorPredicate<E>;\n  protected _cancelPredicate: KeyboardSensorPredicate<E>;\n  protected _endPredicate: KeyboardSensorPredicate<E>;\n\n  constructor(element: Element | null, options: Partial<KeyboardSensorSettings<E>> = {}) {\n    super();\n\n    const {\n      moveDistance = keyboardSensorDefaults.moveDistance,\n      cancelOnBlur = keyboardSensorDefaults.cancelOnBlur,\n      cancelOnVisibilityChange = keyboardSensorDefaults.cancelOnVisibilityChange,\n      startPredicate = keyboardSensorDefaults.startPredicate,\n      movePredicate = keyboardSensorDefaults.movePredicate,\n      cancelPredicate = keyboardSensorDefaults.cancelPredicate,\n      endPredicate = keyboardSensorDefaults.endPredicate,\n    } = options;\n\n    this.element = element;\n    this.moveDistance =\n      typeof moveDistance === 'number' ? { x: moveDistance, y: moveDistance } : { ...moveDistance };\n    this._cancelOnBlur = cancelOnBlur;\n    this._cancelOnVisibilityChange = cancelOnVisibilityChange;\n    this._startPredicate = startPredicate;\n    this._movePredicate = movePredicate;\n    this._cancelPredicate = cancelPredicate;\n    this._endPredicate = endPredicate;\n\n    this._onKeyDown = this._onKeyDown.bind(this);\n    this._internalCancel = this._internalCancel.bind(this);\n    this._blurCancelHandler = this._blurCancelHandler.bind(this);\n\n    document.addEventListener('keydown', this._onKeyDown);\n    if (cancelOnBlur) {\n      element?.addEventListener('blur', this._blurCancelHandler);\n    }\n    if (cancelOnVisibilityChange) {\n      document.addEventListener('visibilitychange', this._internalCancel);\n    }\n  }\n\n  protected _internalCancel() {\n    this.cancel();\n  }\n\n  protected _blurCancelHandler() {\n    // If the Draggable has a container defined the dragged element will be\n    // appended to the container, which will cause the element to lose focus\n    // temporarily in some browsers (e.g. Chrome). Draggable will automatically\n    // restore the focus immediately after the element is appended, but the blur\n    // event will be triggered anyway. This is why we need to defer the cancel\n    // call to the next microtask, where we can check if the element is still\n    // focused.\n    queueMicrotask(() => {\n      if (document.activeElement !== this.element) {\n        this.cancel();\n      }\n    });\n  }\n\n  protected _onKeyDown(e: KeyboardEvent) {\n    // Handle start.\n    if (!this.drag) {\n      const startPosition = this._startPredicate(e, this);\n      if (startPosition) {\n        e.preventDefault();\n        this._start({\n          type: SensorEventType.Start,\n          x: startPosition.x,\n          y: startPosition.y,\n          srcEvent: e,\n        });\n      }\n      return;\n    }\n\n    // Handle cancel.\n    const cancelPosition = this._cancelPredicate(e, this);\n    if (cancelPosition) {\n      e.preventDefault();\n      this._cancel({\n        type: SensorEventType.Cancel,\n        x: cancelPosition.x,\n        y: cancelPosition.y,\n        srcEvent: e,\n      });\n      return;\n    }\n\n    // Handle end.\n    const endPosition = this._endPredicate(e, this);\n    if (endPosition) {\n      e.preventDefault();\n      this._end({\n        type: SensorEventType.End,\n        x: endPosition.x,\n        y: endPosition.y,\n        srcEvent: e,\n      });\n      return;\n    }\n\n    // Handle move.\n    const movePosition = this._movePredicate(e, this);\n    if (movePosition) {\n      e.preventDefault();\n      this._move({\n        type: SensorEventType.Move,\n        x: movePosition.x,\n        y: movePosition.y,\n        srcEvent: e,\n      });\n      return;\n    }\n  }\n\n  updateSettings(options: Partial<KeyboardSensorSettings<E>> = {}) {\n    const {\n      moveDistance,\n      cancelOnBlur,\n      cancelOnVisibilityChange,\n      startPredicate,\n      movePredicate,\n      cancelPredicate,\n      endPredicate,\n    } = options;\n\n    if (moveDistance !== undefined) {\n      if (typeof moveDistance === 'number') {\n        this.moveDistance.x = this.moveDistance.y = moveDistance;\n      } else {\n        this.moveDistance.x = moveDistance.x;\n        this.moveDistance.y = moveDistance.y;\n      }\n    }\n\n    if (cancelOnBlur !== undefined && this._cancelOnBlur !== cancelOnBlur) {\n      this._cancelOnBlur = cancelOnBlur;\n      if (cancelOnBlur) {\n        this.element?.addEventListener('blur', this._blurCancelHandler);\n      } else {\n        this.element?.removeEventListener('blur', this._blurCancelHandler);\n      }\n    }\n\n    if (\n      cancelOnVisibilityChange !== undefined &&\n      this._cancelOnVisibilityChange !== cancelOnVisibilityChange\n    ) {\n      this._cancelOnVisibilityChange = cancelOnVisibilityChange;\n      if (cancelOnVisibilityChange) {\n        document.addEventListener('visibilitychange', this._internalCancel);\n      } else {\n        document.removeEventListener('visibilitychange', this._internalCancel);\n      }\n    }\n\n    if (startPredicate) {\n      this._startPredicate = startPredicate;\n    }\n\n    if (movePredicate) {\n      this._movePredicate = movePredicate;\n    }\n\n    if (cancelPredicate) {\n      this._cancelPredicate = cancelPredicate;\n    }\n\n    if (endPredicate) {\n      this._endPredicate = endPredicate;\n    }\n  }\n\n  destroy() {\n    if (this.isDestroyed) return;\n    super.destroy();\n    document.removeEventListener('keydown', this._onKeyDown);\n    if (this._cancelOnBlur) {\n      this.element?.removeEventListener('blur', this._blurCancelHandler);\n    }\n    if (this._cancelOnVisibilityChange) {\n      document.removeEventListener('visibilitychange', this._internalCancel);\n    }\n  }\n}\n"],"mappings":"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"}