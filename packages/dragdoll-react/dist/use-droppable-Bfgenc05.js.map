{"version":3,"file":"use-droppable-Bfgenc05.js","names":["droppable","effectiveDndObserver","DroppableCore"],"sources":["../src/hooks/use-droppable.ts"],"sourcesContent":["import type { DndObserver, DroppableOptions } from 'dragdoll';\nimport { Droppable as DroppableCore } from 'dragdoll';\nimport { useRef, useState } from 'react';\nimport { useCallbackStable } from './use-callback-stable.js';\nimport { useDndObserverContext } from './use-dnd-observer-context.js';\nimport { useIsomorphicLayoutEffect } from './use-isomorphic-layout-effect.js';\nimport { useMemoStable } from './use-memo-stable.js';\n\nexport interface UseDroppableSettings extends DroppableOptions {\n  element?: HTMLElement | SVGSVGElement;\n  dndObserver?: DndObserver<any> | null;\n}\n\nexport function useDroppable({\n  id,\n  accept,\n  data,\n  element,\n  dndObserver,\n}: UseDroppableSettings = {}) {\n  // Dnd observer from context.\n  const dndObserverFromContext = useDndObserverContext<any>();\n\n  // Effective dnd observer.\n  const effectiveDndObserver = dndObserver === undefined ? dndObserverFromContext : dndObserver;\n\n  // Droppable instance state.\n  const [droppable, setDroppable] = useState<DroppableCore | null>(null);\n\n  // Keep track of the droppable instance in a ref.\n  const droppableRef = useRef<DroppableCore | null>(null);\n\n  // Keep track of the current settings.\n  const settingsRef = useRef({ id, accept, data });\n  settingsRef.current.id = id;\n  settingsRef.current.accept = accept;\n  settingsRef.current.data = data;\n\n  // Keep track of the currently applied id in a ref. We need this to check if\n  // the id has changed since the last time the draggable was created.\n  const appliedIdRef = useRef(id);\n\n  // Keep track of the current effective dnd observer.\n  const dndObserverRef = useRef(effectiveDndObserver);\n  dndObserverRef.current = effectiveDndObserver;\n\n  // Keep track of the applied dnd observer.\n  const appliedDndObserverRef = useRef(effectiveDndObserver);\n\n  // Destroy the droppable.\n  const destroyDroppable = useCallbackStable(() => {\n    const droppable = droppableRef.current;\n    if (!droppable) return;\n    droppable.destroy();\n    droppableRef.current = null;\n    setDroppable(null);\n  }, []);\n\n  // Create the droppable.\n  const createDroppable = useCallbackStable(\n    (node: HTMLElement | SVGSVGElement) => {\n      destroyDroppable();\n\n      // Create the droppable.\n      const effectiveDndObserver = dndObserverRef.current;\n      const droppable = new DroppableCore(node, settingsRef.current);\n\n      // Update refs and state.\n      droppableRef.current = droppable;\n      appliedIdRef.current = settingsRef.current.id;\n      appliedDndObserverRef.current = effectiveDndObserver;\n      setDroppable(droppable);\n    },\n    [destroyDroppable],\n  );\n\n  // Ref callback when element is not explicitly provided.\n  const setRef = useCallbackStable(\n    (node: HTMLElement | SVGSVGElement | null) => {\n      // If user provides an explicit element, do not create a new droppable.\n      // sensor.\n      if (element !== undefined) return;\n\n      // Destroy the droppable if the node is null.\n      if (node === null) {\n        destroyDroppable();\n        return;\n      }\n\n      // Create a new droppable if there is no droppable or the node has\n      // changed.\n      const currentDroppable = droppableRef.current;\n      if (!currentDroppable || currentDroppable.element !== node) {\n        createDroppable(node);\n      }\n    },\n    [element, createDroppable, destroyDroppable],\n  );\n\n  // Handle explicit element change.\n  useIsomorphicLayoutEffect(() => {\n    if (element === undefined) return;\n    createDroppable(element);\n    return destroyDroppable;\n  }, [element, createDroppable, destroyDroppable]);\n\n  // Handle id change. Any time id is updated while there is a droppable, we\n  // need to recreate the droppable with the new id.\n  useIsomorphicLayoutEffect(() => {\n    const droppable = droppableRef.current;\n    if (!droppable) return;\n    if (appliedIdRef.current === id) return;\n    createDroppable(droppable.element);\n  }, [id, createDroppable]);\n\n  // Handle observer change.\n  useIsomorphicLayoutEffect(() => {\n    // Do nothing if the effective dnd observer hasn't changed.\n    const appliedDndObserver = appliedDndObserverRef.current;\n    if (appliedDndObserver === effectiveDndObserver) return;\n\n    // If the droppable exists, remove it from the applied dnd observer and add\n    // it to the effective dnd observer.\n    const droppable = droppableRef.current;\n    if (droppable) {\n      appliedDndObserver?.removeDroppables([droppable]);\n      effectiveDndObserver?.addDroppables([droppable]);\n    }\n\n    // Update the applied dnd observer ref.\n    appliedDndObserverRef.current = effectiveDndObserver;\n  }, [effectiveDndObserver]);\n\n  // Handle accept change.\n  useIsomorphicLayoutEffect(() => {\n    const droppable = droppableRef.current;\n    if (!droppable) return;\n    droppable.accept = accept || (() => true);\n  }, [accept]);\n\n  // Handle data change.\n  useIsomorphicLayoutEffect(() => {\n    const droppable = droppableRef.current;\n    if (!droppable) return;\n    droppable.data = data || {};\n  }, [data]);\n\n  // Cleanup on unmount.\n  useIsomorphicLayoutEffect(() => {\n    return destroyDroppable;\n  }, [destroyDroppable]);\n\n  return useMemoStable(() => {\n    return [droppable, setRef] as const;\n  }, [droppable, setRef]);\n}\n"],"mappings":"+PAaA,SAAgB,EAAa,CAC3B,KACA,SACA,OACA,UACA,eACwB,EAAE,CAAE,CAE5B,IAAM,EAAyB,GAA4B,CAGrD,EAAuB,IAAgB,IAAA,GAAY,EAAyB,EAG5E,CAAC,EAAW,GAAgB,EAA+B,KAAK,CAGhE,EAAe,EAA6B,KAAK,CAGjD,EAAc,EAAO,CAAE,KAAI,SAAQ,OAAM,CAAC,CAChD,EAAY,QAAQ,GAAK,EACzB,EAAY,QAAQ,OAAS,EAC7B,EAAY,QAAQ,KAAO,EAI3B,IAAM,EAAe,EAAO,EAAG,CAGzB,EAAiB,EAAO,EAAqB,CACnD,EAAe,QAAU,EAGzB,IAAM,EAAwB,EAAO,EAAqB,CAGpD,EAAmB,MAAwB,CAC/C,IAAMA,EAAY,EAAa,QAC1BA,IACL,EAAU,SAAS,CACnB,EAAa,QAAU,KACvB,EAAa,KAAK,GACjB,EAAE,CAAC,CAGA,EAAkB,EACrB,GAAsC,CACrC,GAAkB,CAGlB,IAAMC,EAAuB,EAAe,QACtCD,EAAY,IAAIE,EAAc,EAAM,EAAY,QAAQ,CAG9D,EAAa,QAAUF,EACvB,EAAa,QAAU,EAAY,QAAQ,GAC3C,EAAsB,QAAUC,EAChC,EAAaD,EAAU,EAEzB,CAAC,EAAiB,CACnB,CAGK,EAAS,EACZ,GAA6C,CAG5C,GAAI,IAAY,IAAA,GAAW,OAG3B,GAAI,IAAS,KAAM,CACjB,GAAkB,CAClB,OAKF,IAAM,EAAmB,EAAa,SAClC,CAAC,GAAoB,EAAiB,UAAY,IACpD,EAAgB,EAAK,EAGzB,CAAC,EAAS,EAAiB,EAAiB,CAC7C,CAuDD,OApDA,MAAgC,CAC1B,OAAY,IAAA,GAEhB,OADA,EAAgB,EAAQ,CACjB,GACN,CAAC,EAAS,EAAiB,EAAiB,CAAC,CAIhD,MAAgC,CAC9B,IAAMA,EAAY,EAAa,QAC1BA,GACD,EAAa,UAAY,GAC7B,EAAgBA,EAAU,QAAQ,EACjC,CAAC,EAAI,EAAgB,CAAC,CAGzB,MAAgC,CAE9B,IAAM,EAAqB,EAAsB,QACjD,GAAI,IAAuB,EAAsB,OAIjD,IAAMA,EAAY,EAAa,QAC3BA,IACF,GAAoB,iBAAiB,CAACA,EAAU,CAAC,CACjD,GAAsB,cAAc,CAACA,EAAU,CAAC,EAIlD,EAAsB,QAAU,GAC/B,CAAC,EAAqB,CAAC,CAG1B,MAAgC,CAC9B,IAAMA,EAAY,EAAa,QAC1BA,IACL,EAAU,OAAS,QAAiB,MACnC,CAAC,EAAO,CAAC,CAGZ,MAAgC,CAC9B,IAAMA,EAAY,EAAa,QAC1BA,IACL,EAAU,KAAO,GAAQ,EAAE,GAC1B,CAAC,EAAK,CAAC,CAGV,MACS,EACN,CAAC,EAAiB,CAAC,CAEf,MACE,CAAC,EAAW,EAAO,CACzB,CAAC,EAAW,EAAO,CAAC"}