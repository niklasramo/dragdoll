{"version":3,"file":"use-draggable-CMs2hFH6.js","names":["draggable","resolvedSensors","id","effectiveDndObserver"],"sources":["../src/hooks/use-draggable.ts"],"sourcesContent":["import type { DndObserver } from 'dragdoll/dnd-observer';\nimport type { DraggableOptions } from 'dragdoll/draggable';\nimport { Draggable } from 'dragdoll/draggable';\nimport type { Sensor } from 'dragdoll/sensors';\nimport { useRef, useState } from 'react';\nimport { areConfigsEqual } from '../utils/are-configs-equal.js';\nimport { useCallbackStable } from './use-callback-stable.js';\nimport { useDndObserverContext } from './use-dnd-observer-context.js';\nimport { useIsomorphicLayoutEffect } from './use-isomorphic-layout-effect.js';\nimport { useMemoStable } from './use-memo-stable.js';\n\nexport interface UseDraggableSettings<S extends Sensor[] = Sensor[]>\n  extends Partial<DraggableOptions<S>> {\n  dndObserver?: DndObserver<any> | null;\n}\n\nexport function useDraggable<S extends Sensor[] = Sensor[]>(\n  sensors: (S[number] | null)[],\n  settings?: UseDraggableSettings<S>,\n) {\n  // Parse sensors. The sensors might be null when they are waiting to be\n  // created.\n  const resolvedSensors = useMemoStable(() => {\n    return sensors.filter((s) => Boolean(s)) as S;\n  }, [...sensors]);\n\n  // Parse settings.\n  const { id, dndObserver, ...draggableSettings } = settings || {};\n\n  // Dnd observer from context.\n  const dndObserverFromContext = useDndObserverContext<any>();\n\n  // Effective dnd observer.\n  const effectiveDndObserver = dndObserver === undefined ? dndObserverFromContext : dndObserver;\n\n  // The draggable instance state.\n  const [draggable, setDraggable] = useState<Draggable<S> | null>(null);\n\n  // The draggable instance ref.\n  const draggableRef = useRef<Draggable<S> | null>(null);\n\n  // The resolved sensors ref.\n  const resolvedSensorsRef = useRef(resolvedSensors);\n  resolvedSensorsRef.current = resolvedSensors;\n\n  // Keep track of the currently applied id in a ref. We need this to check if\n  // the id has changed since the last time the draggable was created.\n  const appliedIdRef = useRef(id);\n\n  // Keep track of the currently applied options.\n  const appliedSettingsRef = useRef(settings);\n\n  // Keep track of the applied dnd observer.\n  const appliedDndObserverRef = useRef(effectiveDndObserver);\n\n  // Keep track of the current id.\n  const idRef = useRef(id);\n  idRef.current = id;\n\n  // Keep track of the current dnd observer.\n  const dndObserverRef = useRef(effectiveDndObserver);\n  dndObserverRef.current = effectiveDndObserver;\n\n  // Keep track of the current draggable settings.\n  const draggableSettingsRef = useRef(draggableSettings);\n  draggableSettingsRef.current = draggableSettings;\n\n  // Handle draggable destruction.\n  const destroyDraggable = useCallbackStable(() => {\n    const draggable = draggableRef.current;\n    if (!draggable) return;\n    // NB: Any DndObserver that has this draggable will automatically remove\n    // it when the draggable is destroyed.\n    draggable.destroy();\n    draggableRef.current = null;\n    setDraggable(null);\n  }, []);\n\n  // Handle draggable creation.\n  const createDraggable = useCallbackStable(() => {\n    destroyDraggable();\n    const resolvedSensors = resolvedSensorsRef.current;\n    if (resolvedSensors.length === 0) return;\n    const id = idRef.current;\n    const effectiveDndObserver = dndObserverRef.current;\n    const currentDraggableSettings = draggableSettingsRef.current || {};\n\n    // Create the draggable.\n    const draggable = new Draggable<S>(resolvedSensors, {\n      id,\n      ...currentDraggableSettings,\n    });\n\n    // Add the draggable to the effective dnd observer.\n    effectiveDndObserver?.addDraggables([draggable]);\n\n    // Update refs and state.\n    draggableRef.current = draggable;\n    appliedIdRef.current = id;\n    appliedSettingsRef.current = draggableSettingsRef.current;\n    appliedDndObserverRef.current = effectiveDndObserver;\n    setDraggable(draggable);\n  }, [destroyDraggable]);\n\n  // Handle sensors or id change.\n  useIsomorphicLayoutEffect(() => {\n    // No sensors? Destroy the draggable (if it exists).\n    if (!resolvedSensors.length) {\n      destroyDraggable();\n      return;\n    }\n\n    // No draggable? Create a new one.\n    const draggable = draggableRef.current;\n    if (!draggable) {\n      createDraggable();\n      return;\n    }\n\n    // If the sensors have changed, recreate the draggable.\n    if (\n      resolvedSensors.length !== draggable.sensors.length ||\n      resolvedSensors.some((sensor) => !draggable.sensors.includes(sensor))\n    ) {\n      createDraggable();\n    }\n  }, [resolvedSensors, createDraggable, destroyDraggable]);\n\n  // Handle id change. Any time id is updated while there is a draggable, we\n  // need to recreate the draggable with the new id.\n  useIsomorphicLayoutEffect(() => {\n    const draggable = draggableRef.current;\n    if (!draggable) return;\n    if (appliedIdRef.current === id) return;\n    createDraggable();\n  }, [id, createDraggable]);\n\n  // Handle dndObserver change.\n  useIsomorphicLayoutEffect(() => {\n    // Do nothing if the observer hasn't changed.\n    const appliedDndObserver = appliedDndObserverRef.current;\n    if (appliedDndObserver === effectiveDndObserver) return;\n\n    // If the draggable exists, remove it from the applied dnd observer and add\n    // it to the effective dnd observer.\n    const draggable = draggableRef.current;\n    if (draggable) {\n      appliedDndObserver?.removeDraggables([draggable]);\n      effectiveDndObserver?.addDraggables([draggable]);\n    }\n\n    // Update the applied dnd observer ref.\n    appliedDndObserverRef.current = effectiveDndObserver;\n  }, [effectiveDndObserver]);\n\n  // Handle settings change.\n  useIsomorphicLayoutEffect(() => {\n    // Make sure the draggable exists.\n    const draggable = draggableRef.current;\n    if (!draggable) return;\n\n    // Only update if settings have actually changed (deep equality check).\n    // This prevents unnecessary updates when settings object reference changes\n    // but values remain the same.\n    if (!areConfigsEqual(appliedSettingsRef.current, draggableSettings)) {\n      // Here we use the protected method to parse the settings so that we can\n      // use the default settings for the ones that are not provided. This is\n      // the expected behavior in React's declarative nature.\n      draggable.updateSettings(draggable['_parseSettings'](draggableSettings));\n    }\n\n    // Update the applied settings.\n    appliedSettingsRef.current = draggableSettings;\n  }, [draggableSettings]);\n\n  // Cleanup on unmount.\n  useIsomorphicLayoutEffect(() => {\n    return destroyDraggable;\n  }, [destroyDraggable]);\n\n  return draggable;\n}\n"],"mappings":"kUAgBA,SAAgB,EACd,EACA,EACA,CAGA,IAAM,EAAkB,MACf,EAAQ,OAAQ,GAAM,EAAQ,EAAG,CACvC,CAAC,GAAG,EAAQ,CAAC,CAGV,CAAE,KAAI,cAAa,GAAG,GAAsB,GAAY,EAAE,CAG1D,EAAyB,GAA4B,CAGrD,EAAuB,IAAgB,IAAA,GAAY,EAAyB,EAG5E,CAAC,EAAW,GAAgB,EAA8B,KAAK,CAG/D,EAAe,EAA4B,KAAK,CAGhD,EAAqB,EAAO,EAAgB,CAClD,EAAmB,QAAU,EAI7B,IAAM,EAAe,EAAO,EAAG,CAGzB,EAAqB,EAAO,EAAS,CAGrC,EAAwB,EAAO,EAAqB,CAGpD,EAAQ,EAAO,EAAG,CACxB,EAAM,QAAU,EAGhB,IAAM,EAAiB,EAAO,EAAqB,CACnD,EAAe,QAAU,EAGzB,IAAM,EAAuB,EAAO,EAAkB,CACtD,EAAqB,QAAU,EAG/B,IAAM,EAAmB,MAAwB,CAC/C,IAAMA,EAAY,EAAa,QAC1BA,IAGL,EAAU,SAAS,CACnB,EAAa,QAAU,KACvB,EAAa,KAAK,GACjB,EAAE,CAAC,CAGA,EAAkB,MAAwB,CAC9C,GAAkB,CAClB,IAAMC,EAAkB,EAAmB,QAC3C,GAAIA,EAAgB,SAAW,EAAG,OAClC,IAAMC,EAAK,EAAM,QACXC,EAAuB,EAAe,QAItCH,EAAY,IAAI,EAAaC,EAAiB,CAClD,GAAA,EACA,GAL+B,EAAqB,SAAW,EAAE,CAMlE,CAAC,CAGF,GAAsB,cAAc,CAACD,EAAU,CAAC,CAGhD,EAAa,QAAUA,EACvB,EAAa,QAAUE,EACvB,EAAmB,QAAU,EAAqB,QAClD,EAAsB,QAAUC,EAChC,EAAaH,EAAU,EACtB,CAAC,EAAiB,CAAC,CA8EtB,OA3EA,MAAgC,CAE9B,GAAI,CAAC,EAAgB,OAAQ,CAC3B,GAAkB,CAClB,OAIF,IAAMA,EAAY,EAAa,QAC/B,GAAI,CAACA,EAAW,CACd,GAAiB,CACjB,QAKA,EAAgB,SAAWA,EAAU,QAAQ,QAC7C,EAAgB,KAAM,GAAW,CAACA,EAAU,QAAQ,SAAS,EAAO,CAAC,GAErE,GAAiB,EAElB,CAAC,EAAiB,EAAiB,EAAiB,CAAC,CAIxD,MAAgC,CACZ,EAAa,SAE3B,EAAa,UAAY,GAC7B,GAAiB,EAChB,CAAC,EAAI,EAAgB,CAAC,CAGzB,MAAgC,CAE9B,IAAM,EAAqB,EAAsB,QACjD,GAAI,IAAuB,EAAsB,OAIjD,IAAMA,EAAY,EAAa,QAC3BA,IACF,GAAoB,iBAAiB,CAACA,EAAU,CAAC,CACjD,GAAsB,cAAc,CAACA,EAAU,CAAC,EAIlD,EAAsB,QAAU,GAC/B,CAAC,EAAqB,CAAC,CAG1B,MAAgC,CAE9B,IAAMA,EAAY,EAAa,QAC1BA,IAKA,EAAgB,EAAmB,QAAS,EAAkB,EAIjE,EAAU,eAAeA,EAAU,eAAkB,EAAkB,CAAC,CAI1E,EAAmB,QAAU,IAC5B,CAAC,EAAkB,CAAC,CAGvB,MACS,EACN,CAAC,EAAiB,CAAC,CAEf"}